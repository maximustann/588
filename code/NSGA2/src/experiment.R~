source("preData.R")
source("nsga2.R")
library(mco)
library(nsga2R)
library(foreach)
library(doMC)
registerDoMC(8)

run <- function(problem = 5, initialisation = F){
	#-------------------------------Set up Problem Start-----------------------------
	if(problem == 1){
		noService <- 20
		noCandLoc <- 5
		noUserCen <- 10
		limitation <- noService * noCandLoc * 100
	} else if(problem == 2){
		noService <- 20
		noCandLoc <- 10
		noUserCen <- 10
		limitation <- noService * noCandLoc * 100
	} else if(problem == 3){
		noService <- 50
		noCandLoc <- 15
		noUserCen <- 20
		limitation <- noService * noCandLoc * 100
	} else if(problem == 4){
		noService <- 50
		noCandLoc <- 15
		noUserCen <- 40
		limitation <- noService * noCandLoc * 100
	} else if(problem == 5){
		noService <- 50
		noCandLoc <- 25
		noUserCen <- 20
		limitation <- noService * noCandLoc * 100
	} else if(problem == 6){
		noService <- 50
		noCandLoc <- 25
		noUserCen <- 40
		limitation <- noService * noCandLoc * 100
	}else if(problem == 7){
		noService <- 100
		noCandLoc <- 15
		noUserCen <- 20
		limitation <- noService * noCandLoc * 100
	} else if(problem == 8){
		noService <- 100
		noCandLoc <- 15
		noUserCen <- 40
		limitation <- noService * noCandLoc * 100
	} else if(problem == 9){
		noService <- 100
		noCandLoc <- 25
		noUserCen <- 20
		limitation <- noService * noCandLoc * 100
	} else if(problem == 10){
		noService <- 100
		noCandLoc <- 25
		noUserCen <- 40
		limitation <- noService * noCandLoc * 100
	} else if(problem == 11){
		noService <- 200
		noCandLoc <- 25
		noUserCen <- 40
		limitation <- noService * noCandLoc * 100
	} else if(problem == 12){
		noService <- 200
		noCandLoc <- 25
		noUserCen <- 80
		limitation <- noService * noCandLoc * 100
	} else if(problem == 13){
		noService <- 200
		noCandLoc <- 40
		noUserCen <- 40
		limitation <- noService * noCandLoc * 100
	} else if(problem == 14){
		noService <- 200
		noCandLoc <- 40
		noUserCen <- 80
		limitation <- noService * noCandLoc * 100
	}

	#-------------------------------Set up Problem End-----------------------------
	NSGAdata <- vector()
	GAdata <- vector()
	NSGAtime<- vector()
	GAtime<- vector()

	#------------------------------Proprocessing Functions Start------------------------
	search_maximum_latency <- function(noService, noCandLoc, noUserCen){
		initial_matrix <- matrix(c(rep(1, noService), rep(0, noService * (noCandLoc - 1))), nrow = noService)
		latency <- 0.0
		for(row_iter in 1:noService){
			for(col_iter in 1:noCandLoc){
				if(row_iter == 1 && col_iter == 1){
					latency <- unNormalized_latency_fitness(initial_matrix, noService, noCandLoc, noUserCen)
					next
				}
				num <- which(initial_matrix[row_iter, ] == 1)
				initial_matrix[row_iter, num] <- 0
				initial_matrix[row_iter, col_iter] <- 1
				current_latency <- unNormalized_latency_fitness(initial_matrix, noService, noCandLoc, noUserCen)
				if(current_latency > latency){
					latency <- current_latency
				}
				else{
					initial_matrix[row_iter, col_iter] <- 0
					initial_matrix[row_iter, num] <- 1
				}
			}
		}
		latency
	}

	#-------------------------------Set up Problem End-----------------------------
	NSGAdata <- vector()
	GAdata <- vector()
	NSGAtime<- vector()
	GAtime<- vector()

	#------------------------------Proprocessing Functions Start------------------------
	search_maximum_latency <- function(noService, noCandLoc, noUserCen){
		initial_matrix <- matrix(c(rep(1, noService), rep(0, noService * (noCandLoc - 1))), nrow = noService)
		latency <- 0.0
		for(row_iter in 1:noService){
			for(col_iter in 1:noCandLoc){
				if(row_iter == 1 && col_iter == 1){
					latency <- unNormalized_latency_fitness(initial_matrix, noService, noCandLoc, noUserCen)
					next
				}
				num <- which(initial_matrix[row_iter, ] == 1)
				initial_matrix[row_iter, num] <- 0
				initial_matrix[row_iter, col_iter] <- 1
				current_latency <- unNormalized_latency_fitness(initial_matrix, noService, noCandLoc, noUserCen)
				if(current_latency > latency){
					latency <- current_latency
				}
				else{
					initial_matrix[row_iter, col_iter] <- 0
					initial_matrix[row_iter, num] <- 1
				}
			}
		}
		latency
	}
	
	search_minimum_cost <- function(noService, noCandLoc){
		matrixSize <- noService * noCandLoc
		mini_cost_matrix <- matrix(rep(0, matrixSize), nrow = noService)
		for(row_iter in 1:noService){
			pos <- which(cost_matrix[row_iter, ] == min(cost_matrix[row_iter, ]))[1]
			mini_cost_matrix[row_iter, pos] <- 1
		}
		mini_cost_matrix
	}

	best_front <- function(gadata){
		temp <- unique(gadata[, 1:2])
		ga <- vector()
		best_ga <- vector()
		ranking <- fastNonDominatedSorting(temp)
		rnkIndex <- integer()
		i <- 1
		while (i <= length(ranking)){
			rnkIndex[ranking[[i]]] <- i
			i <- i + 1
		}
		ga <- cbind(temp, rnkIndex)
		best_ga <- ga[ga[, 3] == 1,]
		best_ga
	}
	#------------------------------Proprocessing Functions End------------------------
	#------------------------------Preprocessing Start-------------------------------
	predata(noService, noCandLoc, noUserCen)
	max_cost <- sum(cost_matrix)
	min_cost <- sum(search_minimum_cost(noService, noCandLoc) * cost_matrix)
	max_latency <- search_maximum_latency(noService, noCandLoc, noUserCen)
	min_latency <- 0
	#------------------------------Preprocessing End--------------------------------
	foreach(iter = 1:40) %dopar%{
		cat("Generation:", iter, '\n')

		NSGAdata <- run_algorithm(noService, noCandLoc, noUserCen, iter, limitation, max_cost, min_cost, max_latency, min_latency, initialisation)
		
		if(initialisation == T){

			NSGAtime <- NSGAdata[1, 3]
			filename_nsga <- paste("../result/", problem, '/', iter, "_initialisation_nsga.csv", sep = "")
			filename_nsga_time <- paste("../result/", problem, '/', iter, "_initialisation_time_nsga.csv", sep = "")
			write.csv(NSGAdata[, 1:2], filename_nsga, quote = F, row.names = F)
			write.csv(NSGAtime, filename_nsga_time, quote = F, row.names = F)
		}
		else{
			NSGAtime <- NSGAdata[1, 3]
			filename_nsga <- paste('../result/', problem, '/', iter, "_nsga.csv", sep = "")
			filename_nsga_time <- paste("../result/", problem,'/', iter, "_time_nsga.csv", sep = "")
			write.csv(NSGAdata[, 1:2], filename_nsga, quote = F, row.names = F)
			write.csv(NSGAtime, filename_nsga_time, quote = F, row.names = F)
		}

	}

	for(iter in 1:40){
		if(initialisation == T){
			filename_nsga <- paste('../result/', problem, '/', iter, "_initialisation_nsga.csv", sep = "")
			filename_nsga_time <- paste('../result/', problem, '/', iter, "_initialisation_time_nsga.csv", sep = "")
			NSGAdata <- rbind(NSGAdata, read.csv(filename_nsga, header = T, sep = ','))
			NSGAtime <- rbind(NSGAtime, read.csv(filename_nsga_time, header = T, sep = ","))
		}
		else{
			filename_nsga <- paste('../result/', problem, '/', iter, "_nsga.csv", sep = "")
			filename_nsga_time <- paste('../result/', problem, '/', iter, "_time_nsga.csv", sep = "")
			NSGAdata <- rbind(NSGAdata, read.csv(filename_nsga, header = T, sep = ','))
			NSGAtime <- rbind(NSGAtime, read.csv(filename_nsga_time, header = T, sep = ","))
		}
	}

	time_data <- rbind(NSGAtime, GAtime)
	best_nsga <- best_front(NSGAdata)
	data <- rbind(best_nsga[, 1:2], GAdata)
	colnames(data) <- c("costF", "latencyF")
	if(initialisation == T){
		filename <- paste('../result/', problem, '/', problem, "_initialisation.csv", sep = "")
		filename_time <- paste('../result/', problem, '/', problem, "_initialisation_time.csv", sep = "")
	}
	else{
		filename <- paste('../result/', problem, '/', problem,  ".csv", sep = "")
		filename_time <- paste('../result/', problem, '/', problem, "_time.csv", sep = "")
	}
	write.csv(data, filename, quote = F, row.names = F)
	write.csv(time_data, filename_time, quote = F, row.names = F)
}
